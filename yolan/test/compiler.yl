[def fs [module require 'fs]]

[def syntax [module require './syntax]]

[def jsBackend [module require './jsBackend]]

[def action [[process get 'argv] get 2]]

[if [eq? action 'compile]
  [fs readFile
    [[process get 'argv] get 3]
    'utf8
    [fn [err data]
      [if err [return err]]
      [# compile exports to js]
      [def js [jsBackend toJS [syntax parse [syntax tokenize data]]]]
      [# reformat js]
      [def uglify [require call null 'uglify-js]]
      [def jsp [uglify get 'parser]]
      [def pro [uglify get 'uglify]]
      [def ast [jsp parse js]]
      [set js [pro gen_code ast [object ['beautify true]]]]
      [fs writeFile
        [[process get 'argv] get 4]
        js
        [fn [err data] [if err [return err]] true]]]]]

[if [eq? action 'prettyprint]
  [fs readFile
    [[process get 'argv] get 3]
    'utf8
    [fn [err data]
      [if err [return err]]
      [def ast [syntax parse [syntax tokenize data]]]
      [def src
        [+ [[[ast slice 1] map [syntax get 'prettyprint]] join '\n\n]]
        '\n]
      [fs writeFile
        [[process get 'argv] get 4]
        src
        [fn [err data] [cond [err [return err]]] true]]]]]

[if [eq? action 'transform]
  [fs readFile
    [[process get 'argv] get 3]
    'utf8
    [fn [err data]
      [if err [return err]]
      [def ast [syntax parse [syntax tokenize data]]]
      [set ast [[module require './transform] transform ast]]
      [def src
        [+ [[[ast slice 1] map [syntax get 'prettyprint]] join '\n\n]]
        '\n]
      [fs writeFile
        [[process get 'argv] get 4]
        src
        [fn [err data] [cond [err [return err]]] true]]]]]

[if [eq? action 'test] [console log 'hello\ world]]

